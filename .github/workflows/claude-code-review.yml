name: Claude AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: pr-diff
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # PR diff ê°€ì ¸ì˜¤ê¸°
          gh pr diff ${{ github.event.pull_request.number }} > pr-diff.txt

          # diff íŒŒì¼ í¬ê¸° í™•ì¸ (ë„ˆë¬´ í¬ë©´ ìš”ì•½)
          if [ $(wc -c < pr-diff.txt) -gt 50000 ]; then
            echo "Diff is too large, creating summary..."
            head -c 50000 pr-diff.txt > pr-diff-trimmed.txt
            mv pr-diff-trimmed.txt pr-diff.txt
            echo "diff_truncated=true" >> $GITHUB_OUTPUT
          else
            echo "diff_truncated=false" >> $GITHUB_OUTPUT
          fi

      - name: Get PR files
        id: pr-files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          gh pr view ${{ github.event.pull_request.number }} --json files --jq '.files[].path' > changed-files.txt
          echo "Changed files:"
          cat changed-files.txt

      - name: Review with Claude
        id: claude-review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Claude APIë¥¼ ì‚¬ìš©í•œ ì½”ë“œ ë¦¬ë·°
          DIFF_CONTENT=$(cat pr-diff.txt)
          FILES_CONTENT=$(cat changed-files.txt)
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"

          # Claude API í˜¸ì¶œ - jqë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜¬ë°”ë¥¸ JSON êµ¬ì„±
          REVIEW=$(jq -n \
            --arg model "claude-sonnet-4-20250514" \
            --argjson max_tokens 4096 \
            --arg diff "$DIFF_CONTENT" \
            --arg files "$FILES_CONTENT" \
            --arg title "$PR_TITLE" \
            --arg body "$PR_BODY" \
            '{
              model: $model,
              max_tokens: $max_tokens,
              messages: [
                {
                  role: "user",
                  content: "ë‹¤ìŒ Pull Requestë¥¼ ë¦¬ë·°í•´ì£¼ì„¸ìš”.\n\n## PR ì •ë³´\n**ì œëª©:** \($title)\n**ì„¤ëª…:** \($body)\n\n## ë³€ê²½ëœ íŒŒì¼ ëª©ë¡\n\($files)\n\n## Diff\n```\n\($diff)\n```\n\në‹¤ìŒ ê´€ì ì—ì„œ ì½”ë“œ ë¦¬ë·°ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”:\n1. **ë²„ê·¸ ë° ì ì¬ì  ì´ìŠˆ**: ë…¼ë¦¬ì  ì˜¤ë¥˜, null pointer, ì˜ˆì™¸ ì²˜ë¦¬ ëˆ„ë½ ë“±\n2. **ì½”ë“œ í’ˆì§ˆ**: ê°€ë…ì„±, ìœ ì§€ë³´ìˆ˜ì„±, ì¤‘ë³µ ì½”ë“œ, ë³µì¡ë„\n3. **ë³´ì•ˆ**: SQL Injection, XSS, ì¸ì¦/ì¸ê°€ ë¬¸ì œ, ë¯¼ê°ì •ë³´ ë…¸ì¶œ\n4. **ì„±ëŠ¥**: ë¹„íš¨ìœ¨ì ì¸ ì¿¼ë¦¬, ë©”ëª¨ë¦¬ ëˆ„ìˆ˜, ë¶ˆí•„ìš”í•œ ì—°ì‚°\n5. **ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤**: ë””ìì¸ íŒ¨í„´, ì½”ë”© ì»¨ë²¤ì…˜, ì•„í‚¤í…ì²˜\n6. **í…ŒìŠ¤íŠ¸**: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€, ì—£ì§€ ì¼€ì´ìŠ¤ ì²˜ë¦¬\n\në¦¬ë·° í˜•ì‹:\n- ë°œê²¬í•œ ì´ìŠˆë¥¼ ì¤‘ìš”ë„ ìˆœìœ¼ë¡œ ì •ë¦¬\n- ê° ì´ìŠˆì— ëŒ€í•´ íŒŒì¼ëª…:ë¼ì¸ ë²ˆí˜¸ ëª…ì‹œ\n- ê°œì„  ì œì•ˆê³¼ ì˜ˆì œ ì½”ë“œ ì œê³µ\n- ê¸ì •ì ì¸ ë³€ê²½ì‚¬í•­ë„ ì–¸ê¸‰\n\ní•œê¸€ë¡œ ì¹œì ˆí•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”."
                }
              ]
            }' | curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d @-)

          # ì‘ë‹µì—ì„œ ë¦¬ë·° ë‚´ìš© ì¶”ì¶œ
          REVIEW_TEXT=$(echo "$REVIEW" | jq -r '.content[0].text')

          # ì—ëŸ¬ ì²´í¬
          if [ -z "$REVIEW_TEXT" ] || [ "$REVIEW_TEXT" == "null" ]; then
            echo "Error: Failed to get review from Claude API"
            echo "Response: $REVIEW"
            exit 1
          fi

          # ë¦¬ë·° ë‚´ìš©ì„ íŒŒì¼ë¡œ ì €ì¥
          echo "$REVIEW_TEXT" > review.txt

          # GitHub ì¶œë ¥ìœ¼ë¡œ ì €ì¥ (multiline)
          {
            echo 'review<<EOF'
            echo "$REVIEW_TEXT"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Post review comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REVIEW_CONTENT=$(cat review.txt)
          TRUNCATED="${{ steps.pr-diff.outputs.diff_truncated }}"

          # ë¦¬ë·° ëŒ“ê¸€ ì‘ì„±
          COMMENT="## ğŸ¤– Claude AI Code Review"$'\n\n'"$REVIEW_CONTENT"

          if [ "$TRUNCATED" == "true" ]; then
            COMMENT="$COMMENT"$'\n\n'"---"$'\n'"âš ï¸ **Note**: Diff was truncated due to size. Review may not cover all changes."
          fi

          COMMENT="$COMMENT"$'\n\n'"---"$'\n'"*Powered by Claude AI | Generated automatically on PR events*"

          # ê¸°ì¡´ Claude ë¦¬ë·° ëŒ“ê¸€ ì°¾ê¸°
          EXISTING_COMMENT=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            | jq '.[] | select(.body | startswith("## ğŸ¤– Claude AI Code Review")) | .id' | head -1)

          if [ -n "$EXISTING_COMMENT" ]; then
            # ê¸°ì¡´ ëŒ“ê¸€ ì—…ë°ì´íŠ¸
            echo "Updating existing comment: $EXISTING_COMMENT"
            gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              /repos/${{ github.repository }}/issues/comments/$EXISTING_COMMENT \
              -f body="$COMMENT"
          else
            # ìƒˆ ëŒ“ê¸€ ì‘ì„±
            echo "Creating new comment"
            gh pr comment ${{ github.event.pull_request.number }} --body "$COMMENT"
          fi

      - name: Summary
        run: |
          echo "âœ… Claude AI code review completed successfully"
          echo "ğŸ“ Review posted to PR #${{ github.event.pull_request.number }}"
